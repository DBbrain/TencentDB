# 腾讯云数据库MySQL常见问题

## 1、参数修改问题

1.如何修改云数据库 MySQL 的配置参数？

(1)	**云数据库 MySQL 控制台方式**：

在云数据库 MySQL 控制台，单击实例名称进入管理页，选择【数据库管理】>【参数设置】，其中常见的 var_name 包括如下变量：
<table>
    <tr>
        <th>变量</th>
        <th>说明</th>
    </tr>
    <tr>
        <td>character_set_server</td>
        <td>服务器默认字符集</td>
    </tr>
    <tr>
        <td>connect_timeout</td>
        <td>连接超时</td>
    </tr>
    <tr>
        <td>long_query_time</td>
        <td>超过该时间的查询为慢查询</td>
    </tr>
    <tr>
        <td>max_allowed_packet</td>
        <td>最大包长度</td>
    </tr>
    <tr>
        <td>max_connections</td>
        <td>最大连接数</td>
    </tr>
    <tr>
        <td>sql_mode</td>
        <td>当前的服务器 SQL 模式</td>
    </tr>
    <tr>
        <td>table_open_cache</td>
        <td>全部线程打开表的个数，增大该值可以增加 mysqld 被请求打开的文件描述符个数</td>
    </tr>
    <tr>
        <td>wait_timeout</td>
        <td>非交互连接超时时间</td>
    </tr>
</table>

(2)	**phpMyAdmin 控制台方式**：

通过 phpMyAdmin 登录云数据库 MySQL 后，单击上方菜单中的【变量】，在下面的变量列表中，单击需要修改的变量对应的【编辑】，对其进行修改后单击【保存】。
 
更多配置参数可在控制台的【数据库管理】>【参数设置】页查看。

2.云数据库 MySQL 怎么设置中文查询？

云数据库 MySQL 目前不支持中文字符。

3.如何设置开启云数据库 MySQL 的定时器功能？

在 云数据库 MySQL 控制台，单击实例名称进入管理页，选择【数据库管理】>【参数设置】页，在参数设置中将 event_scheduler 参数设置为 ON。

4.云数据库 MySQL 超时连接设置太短，如何增加时间？

在 云数据库 MySQL 控制台，单击实例名称进入管理页，选择【数据库管理】>【参数设置】页，在参数设置中修改 wait_timeout 参数。

5.云数据库 MySQL 如何调整 group_concat_max_len 参数？

在 云数据库 MySQL 控制台，单击实例名称进入管理页，选择【数据库管理】>【参数设置】页，在参数设置中修改 group_concat_max_len 参数。

6.云数据库 MySQL 全表扫描的 SQL 语句有什么方法可以找到吗？

默认是不记录全表扫描的语句，可在云数据库 MySQL 控制台【参数设置】中将 log_queries_not_using_indexes 参数设置为 ON，注意不要开太久。

7.云数据库的默认字符集编码如何修改？

云数据库与 MySQL 数据库一样，默认字符集编码格式是：LATIN1，即 ISO-8859-1 编码格式，开发者可以在云数据库控制台修改 Server 端的数据库字符集，目前支持 LATIN1 、GBK、UTF8 、UTF8MB4 四种字符集设置。
虽然云数据库支持默认字符集编码的设置，但我们还是建议您在创建表时，显式的指定表的编码，并在连接建立时指定连接的编码，这样，您的应用将会有更好的移植性，MySQL 默认字符集说明以及修改方法请参见 使用限制。可通过云数据库控制台修改字符集。
## 2、回档相关问题

1.云数据库 MySQL 回档时是否会把当前表数据覆盖？

回档操作会产生新的数据库或表至原实例中。回档完后，您可以看到原来的数据库或表，以及新建的数据库或表。回档后的库表名是原库表名 _bak。

2.云数据库 MySQL 误删了数据如何恢复？

可通过回档恢复数据。MySQL 支持回档到备份周期内的任意时间点。

3.云数据库 MySQL 执行某个存储过程中误删了部分未备份的数据，能否还原数据？

可以使用控制台的回档功能，恢复备份周期内任意时间点的数据 。

4.云数据库 MySQL 回档过程中，如何实时查询回档进度和日志？

回档过程中，可实时查询回档的进度和日志，请参见数据回档。
## 3、备份相关问题

1.为什么无法进行分库表的逻辑备份和下载？

备份新版 升级后，不论是逻辑备份还是物理备份功能都采用了新的压缩算法，故部分下载功能暂时无法使用。您可以通过手动备份里的【逻辑备份】>【指定库表】功能完成分库表的逻辑备份，同时也可以下载已完成的该次备份。

2.为什么会备份失败？

单个实例的表数量超过100万后，可能会造成备份失败，同时也会影响数据库监控，请合理规范表的数量，控制单个实例表数量不超过100万。

3.云数据库 MySQL 的数据和日志备份是否可以关闭？

(1)	不可以关闭。

(2)	数据备份保留天数最少7天，最多732天。后续备份收费后会开通减少备份频率的设置，可以通过减少备份频率来降低备份空间的占用量。

(3)	日志备份保留天数最少7天，最多732天。且必须小于等于数据备份天数。

(4)	说明：备份空间于2019年12月02日0时起开始陆续收费，具体时间请参见 备份空间收费说明。请合理设计备份周期、合理使用备份空间，避免收费后造成额外的费用。

4.为什么下载的备份文件用 tar 解包解压失败？

说明：新版的备份文件由于采用的全新压缩算法，使用原有 tar 工具无法正常解包解压，需要使用 xbstream 和 qpress 工具解包解压。

(1)	下载新版的备份文件后，应该先用 xbstream （xbstream 为 Percona 的一种打包/解包工具）将其解包：

(2)	xbstream -x < test_import_57_backup_20181114115236.xb 

(3)	用 xbstream 解包后会得到后缀名为 .qb 的文件，如：test_import_57_backup_20181114115236.sql.qb

(4)	解包后还需要使用 qpress 解压备份文件：

(5)	qpress -d test_import_57_backup_20181114115236.sql.qp

(6)	解压后得到完整的备份文件，如：test_import_57_backup_20181114115236.sql

5.如何下载 xbstream 和 qpress 的工具？

(1)	xbstream 为 Percona 的 xtrabackup 备份工具下的一个子程序，要使用 xbstream，需要先安装 Percona 的 xtrabackup，可以使用 yum 安装和二进制安装两种方式来安装 xtrabackup。

(2)	qpress下载地址，下载之后通过 tar 命令解出 qpress 二进制文件。

(3)	具体 xtrabackup 和 qpress 的安装方式请参见 使用物理备份恢复数据库。

6.如何自己手动设置 MySQL 备份？

您可以通过离线迁移到本地来备份 MySQL 数据。

7.开发者自己如何备份数据？

云数据库 MySQL 实例每天会进行全量备份，开发者也可以采用云数据库提供的多线程快速导入导出工具进行备份，或者通过 mysqldump 工具自己备份数据。

8.MySQL 如何查看 binlog 日志？

(1)	控制台下载 binlog 到本地，例如下载到云服务器。

(2)	使用 mysqlbinlog 命令查看。MySQL 5.6 需要安装3.4或以上版本的 mysqlbinlog 方支持本地服务器查看 binlog。

9.配置 MySQL 同城双备，能够实现两个实例实时数据同步吗？

可通过云数据库 MySQL 控制台购买 灾备实例 来实现此需求。
## 4、实例升级问题

1.云数据库 MySQL 只读实例能否外网连接？

只读实例支持外网连接和内网连接。

2.云数据库 MySQL 主实例和灾备实例间数据同步频率？

开启同步，完成初始同步后，后续主实例和灾备实例间数据实时同步。

3.云数据库 MySQL 不允许添加临时实例吗？

目前暂不支持添加临时实例。

4.为什么升级实例会失败？

单个实例的表数量超过100万后，可能会造成升级失败，同时也会影响数据库监控，请合理规范表的数量，控制单个实例表数量不超过100万。
## 5、性能相关问题

1.云数据库 MySQL 执行任务时，为什么会卡死？

是并发操作导致的锁等待，属于正常现象。

2.为什么查看云数据库 MySQL 中的中文数据时出现乱码？

您将数据存储到云数据库中时，请登录 MySQL 控制台 进入实例详情页查看该实例的默认字符集。在编写程序时，将 character_set_client、character_set_results、character_set_connection 设置为和云数据库实例相同的字符集。否则，如果存储的数据中有中文，会出现中文数据乱码现象。
例如：云数据库实例的默认字符集为 utf8，在编写程序连接数据库时，需要先执行以下语句，再将中文数据存储到云数据库。
```
SET NAMES 'utf8';
```

3.云数据库 MySQL 连接数占用满了的常见原因和解决方法？

(1)	sleep 线程数很多，建议在控制台调低 wait_timeout 和 interactive_timeout 参数值。

(2)	慢查询堆积，long_query_time 参数值默认10s，建议调成1s - 2s，观察慢查询日志。

(3)	sleep 线程数很少，也没有慢查询堆积，建议在控制台调大 max_connections 参数值。

4.云数据库 MySQL CPU 占比过高的常见原因和解决方法？

(1)	慢查询堆积，请查看实例监控上的慢查询和全表扫描，结合慢查询日志（控制台可下载）进行分析优化，若监控上没有慢查询只有全表扫描，建议在控制台将 long_query_time 调小至1s - 2s，使用一段时间后再分析慢查询。

(2)	没有慢查询堆积，请查看实例监控上的内存占用，若超出实例规格很多，并且磁盘读写量明显增大，表明内存遇到瓶颈，建议升级内存。
## 6、内存分配问题
云数据库 MySQL 的内存是重要的性能参数，常出现由异常 SQL 请求以及待优化的数据库导致的内存利用率升高的情况，严重时还会出现由于 OOM 导致实例发生 HA 切换，影响业务的稳定及可用性。
MySQL 的内存大体可以分为 global 级的共享内存和 session 级的私有内存两部分，共享内存是实例创建时即分配的内存空间，并且是所有连接共享的。私有内存用于每个连接到 MySQL 服务器时才分配各自的缓存，一些特殊的 SQL 或字段类型会导致单个线程可能分配多次缓存，因此当出现 OOM 异常，都是由各个连接私有内存造成的。下面将详细介绍各部分的构成。
### 6.1、共享内存
执行以下命令，查询示例的共享内存分配情况：
```angular2html
show variables where variable_name in ('innodb_buffer_pool_size','innodb_log_buffer_size','innodb_additional_mem_pool_size','key_buffer_size','query_cache_size');
```
说明：5.7版本不支持 innodb_additional_mem_pool_size。

以下参数是内存规格为1000MB实例的共享内存分配情况的查询结果（以下为测试实例配置）：
<table>
    <tr>
        <th>Variable_name</th>
        <th>Value</th>
    </tr>
    <tr>
        <td>innodb_additional_mem_pool_size</td>
        <td>8388608</td>
    </tr>
    <tr>
        <td>innodb_buffer_pool_size</td>
        <td>524288000</td>
    </tr>
    <tr>
        <td>innodb_log_buffer_size</td>
        <td>67108864</td>
    </tr>
    <tr>
        <td>key_buffer_size</td>
        <td>16777216</td>
    </tr>
    <tr>
        <td>query_cache_size</td>
        <td>0</td>
    </tr>
</table>
参数说明：

1.**innodb_buffer_pool_size**

该部分缓存是 Innodb 引擎最重要的缓存区域，是通过内存来弥补物理数据文件的重要手段，在云数据库 MySQL 上会采用实例规格配置的50% - 80%作为该部分大小（上图为1000MB * 0.5 = 500MB）。其中主要包含数据页、索引页、undo 页、insert buffer、自适应哈希索引、锁信息以及数据字典等信息。在进行 SQL 读和写的操作时，首先并不是对物理数据文件操作，而是先对 buffer_pool 进行操作，再通过 checkpoint 等机制写回数据文件。该空间的优点是可以提升数据库的性能、加快 SQL 运行速度，缺点是故障恢复速度较慢。

2.**innodb_log_buffer_size**

该部分主要存放 redo log 的信息，在云数据库 MySQL 上会设置64MB的大小。InnoDB 会首先将 redo log 写在这里，然后按照一定频率将其刷新回重做日志文件中。该空间不需要太大，因为一般情况下该部分缓存会以较快频率刷新至 redo log（Master Thread 会每秒刷新、事务提交时会刷新、其空间少于1/2时同样会刷新）。

3.**innodb_additional_mem_pool_size**

该部分主要存放 InnoDB 内的一些数据结构，在云数据库 MySQL 中统一设置为8MB。通常是在 buffer_pool 中申请内存的时候还需要在额外内存中申请空间存储该对象的结构信息。该大小主要与表数量有关，表数量越大需要更大的空间。

4.**key_buffer_size**

该部分是 MyISAM 表的重要缓存区域，所有实例统一为16M。该部分主要存放 MyISAM 表的键。MyISAM 表不同于 InnoDB 表，其缓存的索引缓存是放在 key_buffer 中的，而数据缓存则存储于操作系统的内存中。云数据库 MySQL 的系统是 MyISAM 引擎的，因此需给予该部分一定量的空间的。

5.**query_cache_size**

该部分是对查询结果做缓存，以减少解析 SQL 和执行 SQL 的开销，在云数据库 MySQL 上关闭了该部分的缓存。主要适合于读多写少的应用场景，因为它是按照 SQL 语句的 hash 值进行缓存的，当表数据发生变化后即失效。

### 6.2、私有内存
执行以下命令，查询示例的 session 私有内存分配情况：
```angular2html
show variables where variable_name in ('read_buffer_size','read_rnd_buffer_size','sort_buffer_size','join_buffer_size','binlog_cache_size','tmp_table_size');
```
查询结果如下（以下为测试实例配置）：
<table>
    <tr>
        <th>Variable_name</th>
        <th>Value</th>
    </tr>
    <tr>
        <td>binlog_cache_size</td>
        <td>32768</td>
    </tr>
    <tr>
        <td>join_buffer_size</td>
        <td>262144</td>
    </tr>
    <tr>
        <td>read_buffer_size</td>
        <td>262144</td>
    </tr>
    <tr>
        <td>read_rnd_buffer_size</td>
        <td>524288</td>
    </tr>
    <tr>
        <td>sort_buffer_size</td>
        <td>524288</td>
    </tr>
    <tr>
        <td>tmp_table_size</td>
        <td>209715200</td>
    </tr>
</table>

参数说明：

1.**read_buffer_size**

分别存放了对顺序扫描的缓存，当 thread 进行顺序扫描数据时会首先扫描该 buffer 空间以避免更多的物理读。

2.**read_rnd_buffer_size**

分别存放了对随机扫描的缓存，当 thread 进行随机扫描数据时会首先扫描该 buffer 空间以避免更多的物理读。

3.**sort_buffer_size**

需要执行 order by 和 group by 的 SQL 都会分配 sort_buffer，用于存储排序的中间结果。在排序过程中，若存储量大于 sort_buffer_size，则会在磁盘生成临时表以完成操作。

4.**join_buffer_size**

MySQL 仅支持 nest loop 的 join 算法，处理逻辑是驱动表的一行和非驱动表联合查找，这时就可以将非驱动表放入 join_buffer，不需要访问拥有并发保护机制的 buffer_pool。

5.**binlog_cache_size**

该区域用来缓存该 thread 的 binlog 日志，在一个事务还没有 commit 之前会先将其日志存储于 binlog_cache 中，等到事务 commit 后会将其 binlog 刷回磁盘上的 binlog 文件以持久化。

6.**tmp_table_size**

不同于上面各个 session 级的 buffer，这个参数可以在控制台上修改。该参数是指用户内存临时表的大小，如果该 thread 创建的临时表超过它设置的大小会把临时表转换为磁盘上的一张 MyISAM 临时表。

## 7、内存利用率过高问题
### 7.1、利用率过高
在 MySQL 使用过程中，出现 CPU 利用率过高甚至超过100%时，与数据库存在低效 SQL 或大量行锁冲突有非常大的关系，一般都是由于大量低效的 SQL 导致，出现行锁冲突的概率非常低。

若 MySQL CPU 的利用率长时间处于100%，会严重影响数据库的整体性能，极端情况下可能会出现实例 HANG 住的情况，当 HA 探测到实例 HANG 住后，为了保证用户业务的高可用性，会触发主备切换，在主备切换的过程中，业务会出现短时间的不可用，实例不可用的时长正常情况下不超过60秒。如在业务高峰期发生了主备切换，会严重影响业务的稳定和连续性。
为避免业务因 CPU 资源不足而受影响，建议提前对 CPU 利用率过高的实例进行业务优化或者升级 CPU 资源。实例发生主备切换时会出现秒级的闪断，对于长连接需要应用具备重连的机制。

MySQL CPU 利用率过高，大部分原因与低效 SQL 有关系，通过优化低效 SQL 基本可以解决大部分问题。

MySQL 慢查询时间（long_query_time）的默认值是10s，在遇到性能问题时，若发现没有慢查询，建议将其参数调成1s ，再观察业务周期内的慢查询，进而对其慢查询进行优化。若参数调整后，在其业务周期内依然未发现慢查询，而 CPU 利用率依然偏高，建议升级 CPU 的配置，进而提高数据库的整体性能。

### 7.2、内存利用率过高
云数据库 MySQL 的内存是重要的性能参数，常出现由于低效 SQL 请求以及待优化的数据库导致内存利用率过高甚至超过100%的情况。

由于低效 SQL 请求以及待优化的数据库导致内存利用率升高的问题时，若您使用的是 MySQL 高可用版数据库，严重时还会触发内存 OOM 进而发生主备切换，主备切换过程中会导致业务短时间不可用，实例不可用的时长正常情况下不超过60秒。如在业务高峰期发生了主备切换，会严重影响业务的稳定和连续性。
为避免业务因内存利用率过高而受影响，建议您提前对内存利用率过高的实例进行业务优化或者升级内存空间。实例发生主备切换时会出现秒级的闪断，对于长连接需要应用具备重连的机制。

MySQL 的内存大体可以分为 global 级的共享内存和 session 级的私有内存两部分：

(1)共享内存是实例创建时即分配的内存空间，并且是所有连接共享的。

(2)私有内存用于每个连接到 MySQL 服务器时才分配各自的缓存。

一些特殊的 SQL 或字段类型会导致单个线程可能分配多次缓存，因此当出现 OOM 异常，都是由各个连接的私有内存造成的，通过限制数据库的连接数和优化低效 SQL，可降低内存利用率过高的风险，若 MySQL 的内存利用率依然过高，可通过升级内存配置来提升数据库的整体并发量和稳定性。
## 8、同步延迟问题
1.云数据库 MySQL 对应的默认备库、灾备实例、只读实例均采用 MySQL 原生 binlog 复制技术，当数据复制方式为异步复制或半同步复制时，都有可能发生延迟。

(1)	若备库存在延迟，会导致主备实例无法在短时间内完成切换，进而影响业务无法在短时间内恢复正常。

(2)	若灾备实例存在延迟，在堆积的 binlog 未应用完之前，灾备实例将无法顺利升级为主实例，在此期间业务的连续性会因此受到影响。

(3)	若读业务对数据一致性有较高要求，只读组可以设置延迟剔除策略，当只读实例与主实例延迟时间超过阈值，对应的只读实例会被自动剔除，从而导致读业务无法正常访问只读实例。

2.通过监控功能可查看【主从延迟时间】，若主从延迟时间大于0表示其实例存在数据延迟。常见原因如下：

(1) **无主键或二级索引**

若 binlog 为 row 格式且表无主键或二级索引，当对大表进行 DML 操作（例如 delete、update、insert），在从库进行 binlog 日志应用时，会根据主键或者二级索引来检索需要更改的行，如对应表未创建主键或者二级索引，会产生大量的全表扫描进而降低了日志应用速度，从而产生数据延迟。
为所有表创建主键，若表无法创建主键，建议选择基数高的列创建二级索引。建议采用 truncate 命令删除表所有记录。

(2)	**大事务**

当主实例执行大数据量的 DML 操作，大量的 binlog 日志传送到从库时，从库需要花费与主实例相同的时间来完成相应事务，进而导致从库出现数据延迟。
建议将大事务拆分为小事务，通过 where 条件限制每次要处理的数据量，有助于从库迅速完成事务的执行，从而避免出现从库数据的延迟。

(3)	**DDL 操作**

与大事务原理类似，若 DDL 操作在主实例的执行时间很长，在从库也会花费相同甚至更长时间来执行该操作，从而阻塞了 DDL 操作。
建议在业务低峰期执行 DDL 操作。若因灾备实例、只读实例的查询业务而阻塞了 DDL 操作，建议直接 KILL 掉引起阻塞的会话来恢复主从数据的同步。

(4)	**实例规格过小**

只读实例、灾备实例的规格小于主实例且负载较高，会导致只读实例、灾备实例的数据延迟。
建议只读实例、灾备实例规格大于等于主实例，如果只读实例、灾备实例承载了大量的分析类业务导致实例负载过高，需将其实例规格升级至合适的配置或者对其性能低效的 SQL 进行优化。

## 9、运维常见问题

### 9.1、云数据库 MySQL 使用 pt-online-schema-change 问题
云数据库 MySQL 5.6 版本开始支持 Online DDL。5.5版本做表结构变更时，为了避免锁表导致的业务影响，仍然建议用户使用 pt-online-schema-change 等开源工具完成该类操作，但不少用户通过 CVM 使用 pt-online-schema-change 对 MySQL 表结构变更时，遇到问题。

1.常见报错信息：
```angular2html
Use of uninitialized value $host in string eq at /usr/local/percona-toolkit-3.0.3/bin/pt-online-schema-change line 4284.
```
2.查看对应的源码：
```angular2html
sub _find_slaves_by_processlist {
    my ( $self, $dsn_parser, $dbh, $dsn ) = @_;
    my @slaves = map  {
        my $slave        = $dsn_parser->parse("h=$_", $dsn);
        $slave->{source} = 'processlist';
        $slave;
    }
    grep { $_ }
    map  {
        my ( $host ) = $_->{host} =~ m/^([^:]+):/;
        if ( $host eq 'localhost' ) {
            $host = '127.0.0.1'; # Replication never uses sockets.
        }
        $host;
    } $self->get_connected_slaves($dbh);
    return @slaves;
}
```
3.从代码上看是在通过 processlist 的方式寻找 slave 的信息，由于 TencentDB 对复制账号相关的信息做过处理，导致通过 processlist 拿不到 slave 的信息。

4.修复方式:
```angular2html
使用 pt-osc 的时候加上如下参数，不去检查 slave 的状态
--recursion-method=none
```
### 9.2、TencentDB 导入数据报错 Specified key was too long
客户通过 CVM 的命令行向 MySQL 导入 XXXX.sql 文件时，MySQL 返回 Specified key was too long 的报错。

报错信息 “ERROR 1071 (42000): Specified key was too long; max key length is 767 bytes”，其意思是“索引字段长度太长，超过了767bytes”。

1.innodb 存储引擎，多列索引的长度限制如下：

每个列的长度不能大于767bytes，所有组成索引列的长度和不能大于3072bytes。

2.myisam 存储引擎，多列索引的长度限制如下：

每个列的长度不能大于1000bytes，所有组成索引列的长度和不能大于1000bytes。

3.说明：768 / 2 = 384个双字节或者767 / 3 = 255个三字节的字段（GBK 是双字节的、UTF8 是三字节的、UTF8MB4 是四字节的）

MySQL 5.6 及其以上版本，所有 myisam 表都会被自动转换为 innodb，所以在自建数据库上有超过767bytes的组合索引列，但是由于在自建库上 myisam 存储引擎，同样的建表语句在自建库上运行没问题，但是在 MySQL 5.6 版本以上就会有问题。

### 9.3、解决方案
#### 9.3.1、修改备份文件中出错行组合索引列的长度。
1.常见：create table test(test varcahr(255) primary key)charset=utf8;

2.-- 成功：create table test(test varcahr(256) primary key)charset=utf8;

3.-- 失败：ERROR 1071（42000）:Specified key was too long; max key length is 767 bytes

4.使用 TencentDB 5.5 版本，myisam 引擎不会被自动转换为 innodb。

#### 9.3.2、select * from XX into outfile xxxx 报错是什么原因呢？
由于平台安全性原因，不支持开通 file 权限，不支持使用 select into outfile 方式导出数据 ，建议您使用其他方式导出。

#### 9.3.3、MySQL 数据库插入 emoji 表情乱码怎么办？
需排查 MySQL 实例内部、客户端、到 MySQL 实例的连接3个方面，是否未统一使用或者支持 utf8mb4 字符集。

要实现存储 emoji 表情到 MySQL 实例，需要 MySQL 实例内部、客户端、到 MySQL 实例的连接3个方面统一使用或者支持 utf8mb4 字符集。

1.首先需要 MySQL 实例设置字符集为 utf8mb4。可以通过登录控制台修改character_set_server参数。注意：修改此参数会使数据库重启，建议您提前备份数据库，避免出现不必要的损失。

2.用户的程序客户端需要保证输出的字符串的字符集为 utf8mb4。

3.应用程序创建连接是需要指定执行字符集，以常见的 jdbc 连接为例。对于jdbc连接，需要使用 MySQL Connector/J 5.1.13（含）以上的版本，示例代码如下：
<ul>
    <li>String query = “set names utf8mb4”;</li>
    <li>stat.execute(query);</li>
</ul>

#### 9.3.4、常见参数修改以及意义
云数据库 MySQL 已在官方的默认值基础上进行了优化，但基于客户不同的业务场景，在购买实例后，根据您的业务场景建议对以下参数进行合理的配置：

1.**character_set_server**

(1)	默认值：LATIN1

(2)	是否需要重启：是

(3)	作用：用于配置 MySQL 服务器的默认字符集。云数据库 MySQL 提供4种字符集，分别为 LATIN1、UTF8、GBK、UTF8MB4，其中 LATIN1 支持英文字符，一个字符占用一个字节；UTF8 包含全世界所有国家需要用到的字符，是国际编码，通用性强，一个字符占用三个字节；GBK 的文字编码是用双字节来表示的，即不论中、英文字符均使用双字节来表示；UTF8MB4 作为 UTF8 的超集，完全向下兼容，一个字符占用四个字节，且支持 emoji 表情。

(4)	建议：购买实例后，根据业务所需要支持的数据格式选择适合的字符集，确保客户端与服务器端设置相同的字符集，避免因字符集设置不正确而引发乱码的问题和不必要的重启操作。

2.**lower_case_table_names**

(1)	默认值：0

(2)	是否需要重启：是

(3)	作用：创建数据库及表时，存储与查询时是否大小写敏感。该参数可以设置的值为0、1，默认的参数值为0，表示创建数据库及表时，存储与查询均区分大小写，反之则不做区分。

(4)	建议：数据库 MySQL 默认大小写敏感，请根据您的业务需求及使用习惯进行合理的配置。

3.**sql_mode**

(1)	默认值：NO_ENGINE_SUBSTITUTION（5.6版本），ONLY_FULL_GROUP_BY、STRICT_TRANS_TABLES、NO_ZERO_IN_DATE、NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO、NO_AUTO_CREATE_USER、NO_ENGINE_SUBSTITUTION（5.7版本）

(2)	是否需要重启：否

(3)	作用：MySQL 可以运行在不同 sql 模式，sql 模式定义了 mysql 应该支持的 sql 语法、数据校验等。

(4)	该参数5.6版本的默认参数值为NO_ENGINE_SUBSTITUTION，表示使用的存储引擎被禁用或未编译则抛出错误；5.7版本的默认参数值为ONLY_FULL_GROUP_BY、STRICT_TRANS_TABLES、NO_ZERO_IN_DATE、NO_ZERO_DATE、ERROR_FOR_DIVISION_BY_ZERO、NO_AUTO_CREATE_USER、NO_ENGINE_SUBSTITUTION。其中：
<ul>
    <li>ONLY_FULL_GROUP_BY表示在 GROUP BY 聚合操作时，如果在 SELECT 中的列、HAVING 或者 ORDER BY 子句的列，必须是 GROUP BY 中出现或者依赖于 GROUP BY 列的函数列。</li>
    <li>STRICT_TRANS_TABLES为启用严格模式；NO_ZERO_IN_DATE 是否允许日期中的月份和日包含 0，且受是否开启严格模式的影响。</li>
    <li>NO_ZERO_DATE数据库不允许插入零日期，且受是否开启严格模式的影响。</li>
    <li>ERROR_FOR_DIVISION_BY_ZERO在严格模式下，INSERT 或 UPDATE 过程中，如果数据被零除，则产生错误而非警告，而非严格模式下，数据被零除时 MySQL 返回 NULL。</li>
    <li>NO_AUTO_CREATE_USER禁止 GRANT 创建密码为空的用户。</li>
    <li>NO_ENGINE_SUBSTITUTION使用的存储引擎被禁用或者未编译则抛出错误。</li>
</ul>
(5)	建议：由于不同的 SQL 模式支持不同的 SQL 语法，建议根据您的业务场景及开发习惯进行合理的配置。

4.**long_query_time**

(1) 默认值：10

(2) 是否需要重启：否

(3) 作用：用于指定慢查询的界定时间，默认值为10s。当某个查询执行时间为10s及以上，该查询的执行情况会记录于慢日志中，便于过后对慢查询进行分析。

(4) 建议：基于客户业务场景及性能敏感度不同，建议根据各自业务场景设置合理的值，以便事后进行性能分析。

## 10、功能特性问题
1.使用云数据库 MySQL 前要做什么准备？

在使用云数据库 MySQL 前您需要考虑以下两个问题：

(1)	您的应用是否适合使用数据库？例如，数据量小、访问量高、key-value 存储的场景就应该考虑使用内存级持久化存储服务云数据库 Memcached。

(2)	您的数据库设计是否合理？例如，有明显访问热点或者数据量过大的表，则应该考虑拆分成多个表。

2.云数据库 MySQL 如何对 MySQL 进行管理？

开发者不需要对 MySQL 进行日常管理，日常的维护和调整由云数据库运维系统完成。当 MySQL 出现异常时，运维系统会及时发现并通知运维人员处理，开发者不需要做任何变更操作。

3.云数据库 MySQL 后面是否是物理机？

云数据库 MySQL 后面是物理机。

4.云数据库 MySQL 会帮我做分库分表吗？

因为分库分表的标准和业务逻辑相关，所以云数据库 MySQL 不会帮业务做分库分表。

5.云数据库 MySQL 占用空间与使用空间的区别是什么？

目前云数据库 MySQL 用户实际使用空间与 binlog 等日志数据已分开统计，开发者在云数据库控制台看到的占用空间即等于使用空间。

6.云数据库 MySQL 执行任务是否有缓冲？

在很短的时间，送入了 N 条 SQL 语句给云数据库执行，此时云数据库 MySQL 会逐条执行，还是卡死？如果会卡死，那么同时的连接并发数限制是多少？云数据库 MySQL 提供的 MySQL 实例与平时我们自己安装的 MySQL 实例是一样的。并发执行的语句是否会卡死跟系统资源和 SQL 语句本身有关。如果连接数 max_connections 到达极限值，那么该实例基本上已经无法正常提供服务，一般是由以下原因造成的：
<ul>
    <li>业务程序 bug 导致的空连接过多；</li>
    <li>前端过来的访问远远超出实例的处理能力；</li>
    <li>某个连接执行了太久，独占了 MySQL 的资源，导致大量的访问请求被阻塞。</li>
</ul>

7.如何申请开放或关闭云数据库 MySQL 默认备库只读权限？

默认备库不对外提供访问，主要用于高可用切换。

8.云数据库 MySQL 是否支持从库访问？

为了数据库的安全，例如当主实例出现问题时，能快速切换到从库，所以目前不支持对从库进行读写；若希望扩展读写能力，可以考虑升级实例配置或购买只读实例。

9.如何更换云数据库 MySQL 的地域？

暂不支持更换地域，您可以使用数据传输服务DTS来实现两地实例间数据迁移，DTS 支持实时数据同步。数据迁移完毕后，自助退换源实例即可。

10.云数据库 MySQL 实例销毁了怎么办？

实例销毁后会保留在回收站一段时间，包年包月实例会保留7天，按量计费实例保留1天；在此时间段内，可在回收站内找到对应实例，然后进行恢复操作即可找回。

11.帐号误删与忘记密码怎么办？

(1)	若误删帐号，可通过实例管理页中【数据库管理】>【帐号管理】>【创建帐号】或使用 sql 语句进行新建。

(2)	若忘记 root 密码，可通过【数据库管理】>【帐号管理】找到对应帐号进行【重置密码】操作。

(3)	以上操作也可以通过云API接口实现。

12.需要使用 MyISAM 数据库引擎怎么办？

可以使用 MySQL 5.5 版本，此版本支持 MyISAM 引擎。但建议使用更高版本，如 MySQL 5.7 等，使用 InnoDB 引擎，提供更细粒度行级锁，写入性能更高，提供数据完整性保障，可实现数据库故障后数据不丢失。

13.云数据库 MySQL 支持跨地域访问吗？

默认 VPC 网络下不支持跨地域访问的，各地域间 VPC 网络相互隔离。建议购买与云服务器同地域的云数据库 MySQL 实例，数据就近访问，提供业务服务速率及稳定性。

## 11、数据迁移问题
1.如何把本地的 SQL 文件导入到 MySQL 数据库？

登录云数据库 MySQL 控制台，单击实例名进入管理页，选择【数据库管理】>【数据库列表】>【数据导入】，选择导入文件，接下来选择目标数据库，最后确定导入。<br>
**说明**：导入的单个 SQL 文件不超过2GB，文件名仅允许英文、数字、下划线。

2.如何导出数据库数据？

(1)	如果需要导出冷备数据，可在控制台实例管理页的【备份恢复】下载。

(2)	如果需要导出实时数据，可以购买只读实例，通过只读实例 mysqldump 获取。

3.原数据库大概7GB，哪种方式最快迁移至腾讯云购买的 MySQL 数据库中？

建议您使用数据迁移功能，可以直接连到您的源库进行数据同步。

4.想配置同城双备，能够实现两个实例实时数据同步吗？

可在控制台购买灾备实例来实现此需求 。

## 12、一键连接检查工具
如果您无法通过内外网正常访问 MySQL 实例，连接检查工具可协助您轻松排查内外网的连接问题。

### 12.1、内网连接检查
当您通过 CVM 访问 MySQL 实例遇到访问异常的问题时，可以通过 MySQL 控制台所提供的连接检查工具进行内网连接相关问题的排查，仅需简单的操作便能轻松解决内网无法连接的问题。

1.登录云数据库 MySQL 控制台，选择需要排查的 MySQL 实例，在实例管理页中选择【连接检查】页。

2.检查内网连接问题时，需单击【添加访问此实例的云主机】，添加访问此 MySQL 实例的 CVM 实例。说明：选择 CVM 实例时，默认仅提供同地域云服务器，如果您需要跨地域访问，请通过对等连接实现网络互通。

3.添加完成后，单击【开始检查】，在检查任务完成后，会生成检查报告。

4.在检查报告的状态列，单击【查看报告】可查看检查结果。
<ul>
    <li>若检查状态为【正常】，则表示 CVM 实例允许通过内网正常访问该 MySQL 实例。</li>
    <li>若检查状态为【异常】，则表示 CVM 实例无法通过内网正常访问该 MySQL 实例。请参考异常检查项的【处理建议】进行设置，更多内网访问的问题，请参见【无法连接实例问题】。</li>
</ul>

### 12.2、外网连接检查
当您通过外网服务器访问 MySQL 实例遇到访问异常的问题时，可以通过 MySQL 控制台所提供的连接检查工具进行外网连接相关问题的排查，仅需简单的操作便能轻松解决外网无法连接的问题。

1.登录 MySQL 控制台，选择需要排查的 MySQL 实例，在实例详情页中选择【连接检查】>【外网检查】页。

2.检查外网连接问题时，需单击【添加访问此实例的外网服务器】，添加访问此 MySQL 实例的外网服务器。

3.添加完成后，单击【开始检查】，在检查任务完成后，会生成检查报告。

4.在检查报告的状态列，单击【查看报告】可查看检查结果。
<ul>
    <li>若检查状态为【正常】，则表示外网服务器允许通过外网正常访问该 MySQL 实例。</li>
    <li>若检查状态为【异常】，则表示外网服务器无法通过外网正常访问该 MySQL 实例。请参考异常检查项的【处理建议】进行设置，更多外网访问的问题，请参见【无法连接实例问题】。</li>
</ul>

## 13、连接登陆相关问题
1.云服务器与云数据库部署在相同地域上，如何连接 MySQL？

云服务器与云数据库部署在相同地域上时，请使用内网访问，连接方式请参考访问 MySQL 数据库。

2.云服务器与云数据库部署在不同地域上，如何连接 MySQL？

云服务器与云数据库部署在不同地域上时，请使用外网访问，连接方式请参考外网访问。

3.云数据库连接故障诊断及解决方案

当使用云数据库出现连接登录问题时，首先 telnet 验证云数据库的网络端口连通性，然后在云服务器上通过命令行登录云数据库：
<br/>说明：云数据库的帐号默认为 root，密码为初始化选项中配置的帐号密码。

4.mysql -h [云数据库IP] -P[云数据库端口号] -uroot -p[云数据库密码]
<br/>下面是常见的问题类型及解决方案：
<ul>
    <li>当出现 “ERROR 1045(28000):Access denied for user...” 的提示语时，请确认您输入的云数据库帐号、密码是否正确，忘记密码请参考密码重置，如果重复输入正确信息后仍然报该错误，请查看您的实例是否有对访问 IP 做限制，在MySQL 控制台实例详情页的【数据库管理】>【帐号管理】。</li>
    <li>
        当出现 “ERROR 1040(00000):Too many connections” 的提示语时，表明云数据库实例当前最大连接数超过了限制。常见原因及解决方案：
        <br/>1.sleep 线程数很多，建议在控制台调低 wait_timeout和interactive_timeout 参数值。
        <br/>2.慢查询堆积，long_query_time参数值默认10s，建议调成1s - 2s，观察慢查询日志。
        <br/>3.sleep 线程数很少，也没有慢查询堆积，建议在控制台调大 max_connections 参数值。
    </li>
    <li>当出现 “ERROR 2003 (HY000): Can't connect to MySQL server...” 的提示语时，请确认您输入的云数据库的 IP、端口信息是否正确。如果重复输入正确信息后仍然报该错，可以查看该实例控制台的安全组策略，确认该 CVM 是否有访问该 TencentDB 的权限。详见云数据库安全组。</li>
    <li>如果是在数据迁移时遇到连通性测试不通时，请查看是否对提示的迁移代理 IP 做了安全策略的开通。</li>
    <li>用户设置了 init_connect 参数，例如：mysql>set global init_connect='insert into db_monitor.accesslog(thread_id,log_time,localname,matchname) values(connection_id(),now(),user(),current_user())';</li>
    <li>这会触发每个非 super 权限用户的连接，在每次连接数据库都会向 db_monitor.accesslog 表里插入一条记录，一旦 db_monitor.accesslog 表上存在未提交的事务或相关的锁等待，那么 insert into db_monitor.accesslog 表的操作都会被卡住，进而导致非 super 权限用户的所有连接都会被卡住，影响到用户正常使用云数据库。请用户谨慎配置 init_connect 参数。</li>
</ul>

## 14、无法连接实例问题

### 14.1、网络类型不同
若云服务器（CVM）实例和 MySQL 实例的网络类型不一致，则 CVM 实例无法直接通过内网访问 MySQL 实例。

1.CVM 实例采用专有网络（VPC），MySQL 实例采用基础网络

(1)	解决办法一（推荐）：将 MySQL 实例从基础网络切换为 VPC 网络。<br/>
注意：切换后，两者必须处于同一 VPC 网络，才能内网互通。基础网络切换至 VPC 网络后，无法再切换回来。切换后，VPC 网络访问立即生效，原有基础网络的访问将保留24小时，请在24	小时内将该实例相关联的实例迁至 VPC 网络，以保证相关实例的访问。

(2)	解决办法二：重新购买基础网络的 CVM 实例（CVM 实例不支持从 VPC 迁移到基础网络）。但是 VPC 网络比基础网络更安全，建议您使用 VPC 网络。

(3)	解决办法三：CVM 实例使用 MySQL 实例的外网连接地址连接 MySQL 实例。这种方式的性能、安全性、稳定性较差，建议您使用 VPC 网络。

2.CVM 实例采用基础网络，MySQL 实例采用专有网络（VPC）

(1)	解决办法一（推荐）：将 CVM 实例从基础网络迁移到 VPC 网络。<br/>
注意：切换后，两者必须处于同一 VPC 网络才能内网互通。迁移前，请自行解绑内外网负载均衡 CLB 以及弹性网卡，并释放主网卡的辅助 IP，	迁移后再进行绑定。迁移过程中，实例需要进行重启，请勿进行其他操作。迁移后，请注意检查实例运行状态，内网访问以及远程登录是否正常。基础网络切换 VPC 网络后不可逆，CVM 切换至 VPC 网络后与其他基础网络的云服务不互通。

(2)	解决办法二：使用基础网络互通。

(3)	解决办法三：CVM 实例使用 MySQL 实例的外网连接地址连接 MySQL 实例。这种方式的性能、安全性、稳定性较差，建议您使用 VPC 网络。

### 14.2、私有网络不同

1.默认情况下，CVM 实例与 MySQL 实例的网络类型都为 VPC 网络且两者都位于同一 VPC 网络时，才能直接通过内网互通。如果位于不同 VPC，可以采取以下方法使 CVM 和 MySQL 进行互通。

(1)	解决办法一（推荐）：将 MySQL 实例迁移到 CVM 实例所在的 VPC 网络。具体操作：参考 MySQL 的切换网络，将 MySQL 实例的 VPC 网络切换成 CVM 	实例所在的 VPC 网络。

(2)	解决办法二：在两个 VPC 网络之间建立对接连接。

若不采取以上办法，则位于不同 VPC 网络的 CVM 和 MySQL 只能通过公网互	通。这种方式的性能、安全性、稳定性较差。

2.安全组配置有误

若 CVM 实例和 MySQL 实例的安全组配置有误，则 CVM 实例无法直接通过内网或外网访问 MySQL 实例。

3.CVM 实例安全组配置有误

若想要使用 CVM 实例通过内网访问 MySQL 实例，需要在 CVM 安全组中配置出站规则，当出站规格的目标配置不为0.0.0.0/0且协议端口不为 ALL 时，需要把 MySQL 实例的内网 IP 及端口添加到出站规则中。

(1)	登录安全组控制台，单击安全组名称进入 CVM 绑定的安全组详情页。

(2)	选择【出站规则】页，单击【添加规则】。

(3)	填写您的IP地址（段）及需要放通的端口信息（MySQL 内网地址），选择允许放通。

4.MySQL 实例安全组配置有误

若想要指定的 CVM 实例通过内网访问 MySQL 实例或者使用外网访问 MySQL 实例，需要在 MySQL 安全组中配置入站规则，当入站规则的源端配置不为0.0.0.0/0且协议端口不为ALL时，需要把 CVM 实例的内网 IP 或者外网客户端 IP 及端口添加到入站规则中。

(1)	登录安全组控制台，单击安全组名称进入 MySQL 实例绑定的安全组详情页。

(2)	选择【入站规则】页，单击【添加规则】。

(3)	填写您允许访问的 IP 地址（段）及需要放通的端口信息（MySQL 内网端口），选择允许放通。

注意：MySQL 内网默认端口为3306，同时支持自定义端口，若修改过默认端口号，安全组中需放通 MySQL 新端口信息。使用外网访问 MySQL 实例时，安全组入站规则需要放通 MySQL 实例的3306端口。使用外网访问 MySQL 实例时，需将外网客户端的 IP 地址加入安全组入站规中。

## 15、云数据库禁ping原因
为防止云数据库被 DDoS 攻击，MySQL 默认禁止使用 ping 命令来检查网络的连通性。建议您使用 telnet 命令来快速排查和定位网络连通性问题。
1.命令格式如下：
```angular2html
telnet 内网/外网IP地址 内/外网端口
```
2.执行命令后网络访问情况如下：
<ul>
    <li>网络访问正常的情况</li>
    <li>网络访问异常的情况</li>
</ul>

## 16、控制台相关问题
1.为什么 MySQL 实例监控中 max_connections 数值始终显示为1000，而不是实际的当前最大连接数？

实例监控中 max_connections 表示允许的最大连接个数，您可以自定义，最大取值 10240；【当前打开连接数】表示当前时刻实际的连接数，是实时变化的值。

2.如何获知磁盘空间不足？

监控中心对云数据库的磁盘空间进行了监控，当云数据库的使用空间超过90%时，会触发短信和邮件告警，您只需要在云监控中配置好对应的告警接收人，当空间不足的时候就能收到告警。















